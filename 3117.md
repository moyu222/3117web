### 项目原说明

| 功能类别 | 具体需求 |
|----------|-------------------------------------------------------------|
| **用户注册与登录** | - 用户注册时填写基本信息：`login id`、`nickname`、`email`、`type(company/individual)`、`profile image`<br>- 使用 `id + password` 登录<br>- 记住登录状态（即使关闭整个浏览器仍保持登录，使用 cookie）<br>- 用户登出并删除 cookie（登录状态被移除） |
| **公司用户创建职位** | - 公司用户创建职位，包含以下文本信息：`job title`、`job requirement`、`job duty`、`salary` |
| **职位列表** | - 显示系统中所有职位的列表页面（所有用户包括未登录用户都可访问）<br>- 每个职位条目包含一个 "view" 按钮 |
| **职位详情** | - 显示职位详细信息页面（所有用户包括未登录用户都可访问）<br>- 页面包含一个 "apply" 按钮，仅 individual 用户且已登录时可提交申请（包括一条 message 和一个 CV 文件） |
| **申请列表（公司用户）** | - 公司用户查看其收到的所有申请的列表页面 |
| **申请详情（公司用户）** | - 显示申请详细信息页面<br>- 包含职位信息、申请用户信息、CV 文件下载链接 |

### 架构与项目概述

**目标**：实现一个基于 Django 的不分离（模板渲染）在线招聘系统，包含用户注册/登录（含“记住登录”）、公司发布职位、个人查看与申请、公司查看申请并下载 CV。

**系统分层（逻辑）**
- **表示层（Templates）**：Django form/ ModelForm + Bootstrap，负责页面渲染与表单交互（注册/登录/职位列表/详情/申请/公司端申请列表）。
- **业务层（Views）**：Django 视图（函数视图或类视图），处理表单校验、会话、文件上传、权限判断与页面渲染。
- **中间件层（Middleware）**：自定义 Session 过期检查中间件，在每次请求时验证 session 是否已过期，确保逻辑过期时间生效。
- **数据层（Models/ORM）**：Django ORM 管理 `User`、`Job`、`Application` 等模型与数据库交互。


**主要模块（apps）**
- **users**：用户注册、登录、资料、头像上传、会话管理（记住登录）。
- **jobs**：公司创建职位、职位列表与详情展示。
- **applications**：个人申请职位（message + CV）、公司查看申请与下载 CV。

**非功能性约定**
- **数据库**：MySQL

**前端补充说明**
- 使用母版规范 html 界面, 母版添加一个导航栏在所有页面展示
- 前端需要使用 bootstrap jquery 

**后端补充说明**
- users 的 password 使用 Django 默认的 PBKDF2 哈希存储
- 数据库表关联直接使用外键简化, 不要逻辑外键
- **Session 存储**：使用数据库存储 session（`SESSION_ENGINE='django.contrib.sessions.backends.db'`），session 数据存储在数据库中，cookie 中只存储 session key
- **记住登录实现**：当用户勾选"记住我"时，设置 session 过期时间为 30 天（逻辑过期），即使关闭浏览器，session 数据仍在数据库中保留，但会在 30 天后自动过期失效，提高安全性。未勾选"记住我"时，session 过期时间为 2 小时
- **Session 过期检查中间件**：需要创建一个自定义中间件（如 `middleware.SessionExpiryMiddleware`），在每次请求时检查 session 是否已过期（通过 `request.session.get_expiry_date()` 或直接查询数据库中的 session 过期时间）。如果 session 已过期，则清除 session 数据并强制用户重新登录。该中间件应放在 `AuthenticationMiddleware` 之后，确保在认证检查之前完成过期验证
- **密码传输安全**：前端使用 AES 加密密码后再 POST 传输，避免明文传输（真正的安全应依赖 HTTPS）
- **表单验证**：使用 Django 表单验证，不使用 HTML5 的 required 属性，所有验证错误通过 Django 表单显示
- **验证码功能（待实现）**：登录和注册页面需要添加图形验证码，验证码存储在 session 中，1 分钟后过期。详细实现计划见 `users/todo_verification_code.md`

---

### 中间件规划

#### Session 过期检查中间件

**位置**：创建 `middleware.py` 文件（可在项目根目录或 users 应用中）

**功能**：
- 在每次请求时检查当前 session 是否已过期
- 如果 session 已过期，清除 session 数据并强制用户重新登录
- 确保逻辑过期时间生效，即使 cookie 仍然存在

**实现要点**：
- 中间件类名：`SessionExpiryMiddleware`
- 检查方法：通过 `request.session.get_expiry_date()` 获取过期时间，与当前时间比较；或直接查询数据库中的 session 记录检查 `expire_date` 字段
- 过期处理：如果已过期，调用 `request.session.flush()` 清除 session，并可选地重定向到登录页
- 中间件顺序：应放在 `django.contrib.auth.middleware.AuthenticationMiddleware` 之后，确保在认证检查之前完成过期验证

**配置**：在 `settings.py` 的 `MIDDLEWARE` 中添加该中间件

---

### 模型规划 在 model.py 中完善类

#### users 应用 — User（建议扩展 `AbstractUser` 或自定义）
- **字段**
  - `login_id`：字符串，**唯一**，用于登录。
  - `password`：哈希存储（Django auth）。
  - `nickname`：字符串。
  - `email`：EmailField，**唯一**。
  - `type`：字符串枚举，值为 `company` 或 `individual`。
  - `profile_image`：ImageField，可空。
  - `created_at`：DateTimeField，`auto_now_add=True`。
- **索引与方法**
  - 在 `login_id` 与 `email` 上建立唯一索引。
  - 方法：`is_company()`、`is_individual()`。

#### jobs 应用 — Job
- **字段**
  - `company_user`：ForeignKey -> User（仅 company）。
  - `title`：CharField。
  - `requirement`：TextField。
  - `duty`：TextField。
  - `salary`：DecimalField 或 CharField（视需求）。
  - `created_at`：DateTimeField，`auto_now_add=True`。
  - `updated_at`：DateTimeField，`auto_now=True`。
- **约束**
  - `company_user` 必须为 `type='company'`（在保存或视图层校验）。

#### applications 应用 — Application
- **字段**
  - `job`：ForeignKey -> Job。
  - `applicant`：ForeignKey -> User（仅 individual）。
  - `message`：TextField。
  - `cv_file`：FileField（存储到 `MEDIA_ROOT/applications/YYYY/MM/`，文件名使用 UUID 前缀避免冲突）。
  - `status`：CharField，枚举 `submitted/reviewed/accepted/rejected`，默认 `submitted`。
  - `created_at`：DateTimeField，`auto_now_add=True`。
- **索引**
  - 在 `job`、`applicant` 上建立外键索引以加速查询。


---

### RESTful API URL 与请求方式（返回 HTML 的视图路由设计）

> 说明：采用 RESTful 风格的 URL 设计，但视图返回 HTML（模板渲染）。下面列出路径、HTTP 方法、请求参数与典型响应/行为。

#### 用户相关
- **注册页面**
  - `GET  /register/`  
    - **功能**：显示注册表单（字段：login_id, password, password_confirm, nickname, email, type, profile_image）。
  - `POST /register/`  
    - **请求体**：表单数据 + `FILES`（profile_image 可选）。  
    - **行为**：验证、创建用户、登录并重定向到首页或个人资料页。  
    - **响应**：重定向（302）或渲染含错误信息的注册页（400）。

- **登录页面**
  - `GET  /login/`  
    - **功能**：显示登录表单（login_id, password, remember_me checkbox）。
  - `POST /login/`  
    - **请求体**：`login_id`, `password`, `remember_me`。  
    - **行为**：认证成功调用 `login(request, user)`；若 `remember_me` 勾选则设置 `request.session.set_expiry(30*24*3600)`（30天逻辑过期），否则 `set_expiry(0)`（浏览器关闭时过期）。Session 数据存储在数据库中，cookie 中只存储 session key，即使关闭浏览器，session 数据仍保留在数据库中但会在过期时间后自动失效，提高安全性。重定向到首页。  
    - **响应**：重定向或渲染错误信息（401/400）。

- **登出**
  - `POST /logout/`  
    - **行为**：`logout(request)`、`request.session.flush()`，删除数据库中的 session 数据和 cookie 中的 session key，重定向到登录页。  
    - **响应**：重定向（302）。

- **用户资料（可选）**
  - `GET /profile/`  
    - **功能**：显示当前用户资料与编辑入口。

- **首页**
  - `GET /` 或 `GET /home/`  
    - **功能**：显示首页，根据用户类型（company/individual/未登录）显示不同内容。  
    - **行为**：未登录用户显示欢迎页面；已登录用户根据类型显示相应功能入口。  
    - **响应**：HTML 页面。

---

#### 职位相关
- **职位列表**
  - `GET /jobs/`  
    - **查询参数**：`page`（分页），可选 `q`（搜索）。  
    - **行为**：查询所有职位按 `created_at` 降序，分页渲染 `jobs/list.html`。所有用户（包括未登录）都可访问。  
    - **响应**：HTML 页面。

- **职位详情**
  - `GET /jobs/<int:job_id>/`  
    - **行为**：获取职位详情并渲染 `jobs/detail.html`。所有用户（包括未登录）都可访问。若当前用户为 individual 且已登录，则显示"申请"按钮。  
    - **响应**：HTML 页面。

- **创建职位（公司用户）**
  - `GET  /jobs/create/`  
    - **功能**：显示职位创建表单（title, requirement, duty, salary）。  
  - `POST /jobs/create/`  
    - **请求体**：表单数据。  
    - **行为**：仅允许 `request.user.is_authenticated` 且 `is_company()`；保存职位并重定向到职位详情或列表。  
    - **响应**：重定向或错误页面（403/400）。

---

#### 申请相关
- **申请表单**
  - `GET  /applications/create/?job=<id>`  
    - **功能**：显示申请表单（message, cv_file），仅 individual 登录用户可访问。  
  - `POST /applications/create/`  
    - **请求体**：`job_id`, `message`, `FILES['cv_file']`。  
    - **行为**：验证用户类型、保存文件到 `MEDIA_ROOT/applications/YYYY/MM/`（文件名使用 UUID 前缀避免冲突），创建 `Application`，重定向到成功页或职位详情。  
    - **响应**：重定向或错误（403/400）。

- **公司查看申请列表**
  - `GET /company/applications/`  
    - **查询参数**：`page`、可选 `job_id` 过滤。  
    - **行为**：仅公司用户可访问，查询该公司所有职位收到的申请并渲染列表页面。  
    - **响应**：HTML 页面。

- **申请详情与 CV 下载**
  - `GET /company/applications/<int:app_id>/`  
    - **行为**：仅职位所属公司用户可访问，渲染申请详情并提供 CV 下载链接。  
    - **响应**：HTML 页面。
  - `GET /company/applications/<int:app_id>/download-cv/`  
    - **行为**：仅职位所属公司用户可访问，通过 `FileResponse` 返回 CV 文件。  
    - **响应**：文件响应（200，带 `Content-Disposition: attachment`）。

